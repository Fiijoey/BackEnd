// server/routes/inventory-routes.js

const express = require('express');
const router = express.Router();
const pool = require('../database/db-connector'); // Adjust path as needed for your database connection

// Route to display inventory detail page with reviews
router.get('/detail/:inventoryId', async (req, res, next) => {
  try {
    const inventoryId = req.params.inventoryId;
    
    // Query to get vehicle data
    const vehicleQuery = `
      SELECT * FROM inventory 
      WHERE inv_id = ?
    `;
    
    // Query to get reviews for this vehicle
    const reviewsQuery = `
      SELECT * FROM reviews
      WHERE vehicle_id = ?
      ORDER BY created_at DESC
    `;
    
    // Execute vehicle data query
    pool.query(vehicleQuery, [inventoryId], (vehicleErr, vehicleResults) => {
      if (vehicleErr) {
        return next(vehicleErr);
      }
      
      // If no vehicle found, return 404
      if (vehicleResults.length === 0) {
        return res.status(404).render('errors/404', { 
          title: 'Vehicle Not Found',
          message: 'The requested vehicle could not be found.'
        });
      }
      
      const vehicleData = vehicleResults[0];
      
      // Execute reviews query
      pool.query(reviewsQuery, [inventoryId], (reviewsErr, reviewsResults) => {
        if (reviewsErr) {
          return next(reviewsErr);
        }
        
        // Set reviews to query results or empty array if none found
        const reviews = reviewsResults || [];
        
        // Render the detail view with vehicle data and reviews
        // Note: Using 'reviews' instead of 'reviewsList' to match what's expected in detail.ejs
        res.render('inventory/detail', { 
          title: vehicleData.inv_make + ' ' + vehicleData.inv_model,
          vehicleData: vehicleData,
          reviews: reviews // This matches the variable name expected in detail.ejs
        });
      });
    });
  } catch (error) {
    next(error);
  }
});

module.exports = router;

// To use this route in your main server file (e.g., server.js or app.js):
/*
const inventoryRoutes = require('./routes/inventory-routes');
app.use('/inv', inventoryRoutes);
*/